# Google スプレッドシート自動化プロジェクト - 仕様書

## プロジェクト概要

毎月、Web ページから取得した支出データテーブルを、Google スプレッドシートの集計シートに自動入力するツール。
手作業の負担を削減し、データの整合性を確保することが目的。

---

## 1. 背景と課題

### 現在の運用フロー

1. Web ページからテーブルデータを手動コピー
2. スプレッドシート内の「入力シート」に貼付
3. 金額値を集計シートの勘定科目に手動で一致させる
4. 毎月繰り返し

### 課題

- 手作業による手間と時間がかかる
- 複数人が同じ作業を行っているため、組織全体で非効率
- エラーや入力漏れの可能性

### ソリューション

Python スクリプト + Google Sheets API を使用した自動化
- Google Colab で実行（環境構築不要）
- 毎月 2 ステップで完了（データ貼付 → スクリプト実行）

---

## 2. 技術スタック

| 項目 | 技術 |
|------|------|
| 実行環境 | Google Colab（クラウド）|
| 言語 | Python 3 |
| API | Google Sheets API |
| 認証 | OAuth 2.0（Google アカウント）|
| ホスティング | GitHub（スクリプト管理）|
| 料金 | 無料 |

---

## 3. 業務フロー

### 毎月の処理手順

```
Step 1: Web ページからデータ取得
  └─ ログイン必須のため手作業（自動化対象外）
  └─ テーブルをコピー

Step 2: 入力シートに貼付
  └─ スプレッドシートの「入力シート」にテーブルを貼付

Step 3: Python スクリプト実行
  └─ Google Colab を開く
  └─ 認証セルを実行（初回または再接続時）
  └─ メインセルを実行
  └─ **処理対象のスプレッドシート名を入力（キーワード検索）**
  └─ 検索結果から使用するスプレッドシートを選択
  └─ プロンプトで月を入力（例：2025/6）
  └─ **自動的にスプレッドシート全体のバックアップが作成される**
  └─ 自動的に「実績管理シート」に金額が入力される

Step 4: 入力シートをクリア
  └─ 翌月の入力に備えてクリア
```

---

## 4. スプレッドシート構成

### シート一覧

| シート名 | 用途 | 更新頻度 |
|---------|------|--------|
| 入力シート | Web から取得したテーブルの一時貼付先 | 毎月 1 回 |
| 実績管理シート | 最終的な金額入力先（集計用） | スクリプト実行時 |

### 入力シート（一時的）

**構成:**
- A 列：勘定科目コード + 名称（例：「②食費」「④家具・家電」）
- B 列：金額（例：「21,182円」）
- C 列以降：その他の情報（処理対象外）

**データ例:**
```
趣味・娯楽 合計	78,569円	30.81%
④家具・家電	78,569円	30.81%
交際費 合計	79円	0.03%
③税金	79円	0.03%
```

**処理時の除外ルール:**
- 「合計」を含む行は無視される
- 「%」記号の列は無視される

### 実績管理シート（最終出力先）

**構成:**
- A 列：費目（親カテゴリー）
- B 列：詳細（子カテゴリー、**照合キー**）
- C 列：分類
- D 列：予算設定情報
- E 列以降：月次データ（2025/6, 2025/07, 2025/08, ...）

**データ例:**
```
費目              詳細              分類           予算           2025/6  2025/07  2025/08
AI・サブスク費    ①AI・サブスク     1 毎月・固定    6,959        6,959   6,996    500
通信費           ①通信費          1 毎月・固定    6,339        6,339   6,256    6,453
```

---

## 5. データ照合ロジック

### キー照合方式

**照合キー:** 実績管理シートの B 列（詳細）

入力シート の A 列の値 ⇒ 実績管理シート の B 列で完全一致検索

### 照合例

入力シートから取得:
```
②食費           21,182円
④家具・家電     78,569円
①社会保険料     38,500円
```

↓ 実績管理シート B 列と照合

```
②食費 → B列の「②食費」に一致 → 金額を入力
④家具・家電 → B列の「④家具・家電」に一致 → 金額を入力
①社会保険料 → B列の「①社会保険料」に一致 → 金額を入力
```

---

## 6. エラーハンドリング

### エラーパターンと対応

| # | エラーパターン | 検出タイミング | 対応 |
|---|--------------|--------------|------|
| 0 | スプレッドシートが共有ファイル（所有者が異なる） | ステップ 0 | **処理中止** + エラー表示 |
| 1 | B 列（詳細）に重複が存在 | ステップ 2 | **処理中止** + 警告表示 |
| 2 | 入力シートの項目が集計シートに見つからない | ステップ 3 | **警告表示**（処理は継続）|
| 3 | 月の列が存在しない | ステップ 4 | **処理中止** + エラー表示 |
| 4 | 対象月の列に既存データがある | ステップ 5 | **処理中止** + 警告表示 |
| 5 | 金額の形式が不正（「円」除外後に数値化失敗） | ステップ 1 | **警告表示** + スキップ |

### エラー検出フロー

```
ステップ 0: スプレッドシート所有者チェック
  ├─ 現在のユーザーと所有者を比較
  ├─ 共有ファイルを検出 → 【処理中止】（セキュリティ保護）
  ├─ 所有者情報取得失敗 → 【警告表示 + ユーザー確認】
  └─ ✓ 所有者確認完了

ステップ 1: 入力シート読込
  ├─ 「合計」行 → スキップ
  ├─ 金額が数値化できない → 警告表示 + スキップ
  └─ ✓ データマップ作成

ステップ 2: B 列重複チェック
  ├─ 重複検出 → 【処理中止】
  └─ ✓ 重複なし

ステップ 3: 照合チェック
  ├─ 集計シートに見つからない項目 → 【警告表示】（処理継続）
  └─ ✓ 検証完了

ステップ 4: 月の列判定
  ├─ 該当月の列が見つからない → 【処理中止】
  └─ ✓ 列を特定

ステップ 5: 既存データチェック
  ├─ 対象月に既存データ → 【処理中止】
  └─ ✓ 既存データなし

ステップ 6: バックアップ作成
  ├─ スプレッドシート全体をコピー
  ├─ タイムスタンプ付きの名前で保存
  ├─ バックアップ失敗 → 【警告表示 + ユーザー確認】
  └─ ✓ バックアップ完了

ステップ 7: データ貼付
  └─ ✓ 完了
```

### バックアップ機能

**自動バックアップ:**
- データを更新する前に、スプレッドシート全体のコピーが自動的に作成されます
- バックアップ名: `{元のスプレッドシート名}_バックアップ_{YYYY-MM-DD_HH-MM-SS}`
- バックアップは元のスプレッドシートと同じGoogle Driveに保存されます
- バックアップ作成後、URLとIDが表示されます

**バックアップ失敗時の対応:**
- バックアップの作成に失敗した場合、警告が表示されます
- 処理を続行するかどうか確認を求められます（y/n）
- 「n」を選択すると処理が中止されます

---

## 7. 入力仕様

### ユーザー入力

**月の指定（手動入力）**

スクリプト実行時に以下の形式で月を指定:

```
入力形式: YYYY/M または YYYY/MM
例: 2025/6 または 2025/06
範囲: 1 ≦ M ≦ 12
```

**ヘッダー列との照合方式:**

スプレッドシートのヘッダー行（E 列以降）から以下の形式で該当月を検索
```
例: 「2025/6」「2025/07」「2025/08」...
```

---

## 8. データ処理の詳細

### 前処理: スプレッドシート検索・選択

1. ユーザーにスプレッドシート名（の一部）を入力させる
2. `gc.list_spreadsheet_files()` でGoogle Drive内のすべてのスプレッドシートを取得
3. キーワードでフィルタリング（大文字小文字を無視）
4. マッチしたスプレッドシートをリスト表示（名前とID）
5. ユーザーに番号で選択させる
6. 選択されたスプレッドシートを `gc.open_by_key()` で開く
7. 見つからない場合 → 再検索または処理中止

### Step 0: スプレッドシート所有者チェック

1. `google.auth.default()` で認証情報を取得
2. 認証情報から現在のユーザーのメールアドレスを取得
3. `sh.list_permissions()` でスプレッドシートの権限リストを取得
4. 権限リストから `role == 'owner'` のメールアドレスを抽出
5. 現在のユーザーと所有者のメールアドレスを比較（大文字小文字を無視）
6. 不一致の場合 → **処理中止**（セキュリティエラー）
7. 所有者情報取得失敗の場合 → **警告表示** + ユーザー確認

### Step 1: 入力シートからデータ抽出

1. 入力シートの全行を読込
2. ヘッダー行をスキップ
3. 各行について：
   - A 列の値をトリム（前後の空白削除）
   - 「合計」を含む行をスキップ
   - B 列から「円」を削除
   - 数値化を試みる（失敗時は警告）
4. A 列をキー、B 列（金額）を値とした辞書を作成

### Step 2: B 列重複チェック

1. 実績管理シートの全行を読込
2. B 列（詳細）の値をトリムしながら読込
3. ヘッダー行と空セルを除外
4. 同じ値が 2 回以上出現したら → **処理中止**

### Step 3: 照合チェック

1. 入力データのキー（A 列）をループ
2. 実績管理シート B 列で完全一致検索
3. 見つからない場合 → 警告リストに追加（処理継続）

### Step 4: 月の列番号決定

1. ユーザーが月を入力（例：2025/6）
2. 実績管理シートのヘッダー行（E 列以降）をスキャン
3. `年` と `月` を含むセルを検索
4. 該当列の列番号を特定
5. 見つからない場合 → **処理中止**

### Step 5: 既存データチェック

1. 実績管理シートの対象月列をスキャン
2. セルに値が入っている行を検出
3. 1 件以上あれば → **処理中止**（警告表示）

### Step 6: バックアップ作成

1. 現在の日時を取得（YYYY-MM-DD_HH-MM-SS形式）
2. バックアップ名を生成: `{元のスプレッドシート名}_バックアップ_{タイムスタンプ}`
3. gspreadの`copy()`メソッドでスプレッドシート全体をコピー
4. バックアップのURLとIDを表示
5. バックアップ作成失敗時 → **警告表示** + ユーザー確認（処理続行可否）

### Step 7: データ貼付

1. 入力データをループ
2. 各キーについて、実績管理シートの対応行を特定
3. 対象月の列に金額を貼付（上書き）
4. 完了ログを出力

---

## 9. 既存データ上書きルール

### ポリシー

**既存データがある場合は処理中止**

理由：
- 誤上書きのリスク回避
- 同月に複数回実行されるのを防止
- ユーザーが明示的に確認・削除する運用

### 既存データの定義

対象月の列（E 列以降）に、以下のいずれかが入っている場合:
- 数値
- テキスト
- 空白以外のあらゆるデータ

### 対応手順

1. スクリプト実行
2. 既存データが検出される
3. 警告メッセージ表示:
   ```
   ⚠️  警告: 対象月（2025/6）に既存データが見つかりました
   以下の行は既に値が入っています：
   
   行4: '①AI・サブスク' = 6,959
   行5: '①通信費' = 6,339
   
   ❌ 既存データがあるため、処理を中止します。
   既存データを確認・削除してから、もう一度実行してください。
   ```
4. ユーザーが既存データを確認・削除
5. スクリプトを再実行

---

## 10. 月次管理とデータ履歴

### ポリシー

**過去データの自動保存は不要**

理由：
- Web ページにログインすれば、過去データいつでも取得可能
- 過去データを使用して別シートで集計・分析しているため、スプレッドシートとは独立管理
- 新たな履歴管理機構を追加すると保守負担が増加

### 運用方法

- 毎月、当月分のデータのみを集計シートに入力
- 過去データが必要な場合 → Web ページから再取得
- 集計・分析が必要な場合 → 別途シートで実施（本スクリプト対象外）

---

## 11. セキュリティと権限管理

### 認証方式

Google OAuth 2.0
- 初回実行時のみ認証が必要
- 以降は認証キャッシュを使用
- Google アカウントの認証情報がコードに含まれない

### スプレッドシート所有者チェック

**セキュリティ保護機能:**
- スクリプト実行時に、スプレッドシートの所有者を自動確認
- 現在のユーザーとスプレッドシート所有者が一致しない場合、処理を中止
- 共有ファイルへの誤操作を防止

**チェック内容:**
1. 現在認証されているGoogleアカウントのメールアドレスを取得
2. スプレッドシートの所有者のメールアドレスを取得
3. 両者を比較し、一致しない場合はエラー表示して処理中止

**エラーメッセージ例:**
```
❌ エラー: このスプレッドシートはあなたが所有していません
   あなたのアカウント: user@example.com
   スプレッドシート所有者: owner@example.com

⚠️  セキュリティ上の理由から、自分が所有するスプレッドシートのみ処理できます。
   このスプレッドシートは共有ファイルです。処理を中止します。
```

### データアクセス権限

- スクリプトは認証ユーザーのみでアクセス可能
- スプレッドシートの共有設定に基づく
- Google Drive の権限管理に準拠
- **所有者チェックにより、自分が所有するスプレッドシートのみ処理可能**

### コード公開

GitHub に公開予定
- 本スクリプトはスプレッドシート名など環境情報が含まれない
- ユーザーが環境に合わせて修正可能な設計
- API キーやパスワードは含まれない

---

## 12. 使用手順

### セットアップ（初回のみ）

1. Google Colab にアクセス: https://colab.research.google.com/
2. 新しいノートブックを作成
3. Colab に2つのセルを作成:

**セル1（認証用）:**
- 本リポジトリの `auth.py` の内容を貼り付け

**セル2（メイン処理）:**
- 本リポジトリの `main.py` の内容を貼り付け

4. セル1を実行（初回は Google ログイン画面が出現）
5. セル2を実行して動作確認

**ヒント:**
- ファイルを直接コピー＆ペーストするだけでOK
- ノートブックを保存すれば、次回からはセルを実行するだけで使用可能
- GitHubからRawファイルを取得すると、コピーが簡単です

### 毎月の実行手順

1. Web ページからテーブルをコピー
2. スプレッドシートの「入力シート」に貼付
3. Google Colab を開く
4. **セル1（認証）を実行**（再接続時は必須）
5. **セル2（メイン処理）を実行**
6. **スプレッドシート名を入力**（例：`家計簿2025` のようなキーワード）
7. 検索結果から使用するスプレッドシートの番号を選択
8. プロンプトで月を入力（例：`2025/6`）
9. 処理が完了
10. 「入力シート」をクリア（翌月の準備）

### スプレッドシート検索の例

```
処理対象のスプレッドシート名（の一部）を入力してください: 家計簿

検索中: '家計簿' を含むスプレッドシート...

✓ 3件のスプレッドシートが見つかりました:

  [1] 家計簿2025
      ID: 1abc...xyz
  [2] 家計簿2024
      ID: 2def...uvw
  [3] 家計簿テンプレート
      ID: 3ghi...rst

使用するスプレッドシートの番号を入力してください (1-3), または 'r' で再検索: 1

✓ 選択: 家計簿2025
```

### 検索機能の特徴

**柔軟なキーワード検索:**
- ファイル名の一部のみで検索可能（例：「家計簿」で「家計簿2025」がヒット）
- 大文字小文字を区別しない検索
- スペースを含むファイル名にも対応

**再検索機能:**
- 検索結果が見つからない場合、別のキーワードで再検索可能
- 検索結果が多すぎる場合、より具体的なキーワードで再検索可能（'r' を入力）

**ファイルの変更に対応:**
- 毎回キーワード入力を求めるため、ファイル名変更に柔軟に対応
- 年度が変わって新しいスプレッドシートに移行する場合も、キーワードを変更するだけで対応可能

### トラブルシューティング

| エラー | 原因 | 対応 |
|------|------|------|
| `gspread.exceptions.SpreadsheetNotFound` | スプレッドシート名が間違っている | スクリプト内の名前を確認・修正 |
| 「このスプレッドシートはあなたが所有していません」 | スプレッドシートが共有ファイル | 自分が所有するスプレッドシートで実行するか、スプレッドシートのコピーを作成 |
| `KeyError` | B 列のキーが入力シートと一致していない | 入力シートと実績管理シート B 列を確認 |
| 「月が見つかりません」 | ヘッダー形式が異なる | スプレッドシートのヘッダーを確認 |
| 「重複が見つかりました」 | B 列に同じ値が 2 回以上ある | 実績管理シート B 列を確認・修正 |
| 「既存データが見つかりました」 | 対象月に既に値が入っている | 既存データを確認・削除後、再実行 |

---

## 13. スクリプト構成

### ファイル一覧

```
.
├── README.md                    # プロジェクト説明
├── auth.py                      # 認証処理（Colabセル1用）
├── main.py                      # メイン処理（Colabセル2用）
└── .gitignore                   # Git 除外設定
```

### ファイル説明

**auth.py - 認証処理**
- Google Colab の最初のセル（セル1）に貼り付けて使用
- Google アカウント認証を実行
- 初回実行時およびColabへの再接続時に必須

**main.py - メイン処理**
- Google Colab の2番目のセル（セル2）に貼り付けて使用
- スプレッドシート検索・選択、データ処理の全機能を含む
- 関数分離により保守性・可読性を向上

### スクリプト内の処理ステップ

```python
前処理: スプレッドシート検索・選択
ステップ 0: スプレッドシート所有者チェック（セキュリティ保護）
ステップ 1: 入力シートからデータ読込
ステップ 2: B 列重複チェック
ステップ 3: 照合チェック
ステップ 4: 月の列番号を決定
ステップ 5: 既存データをチェック
ステップ 6: スプレッドシートのバックアップコピー作成
ステップ 7: データを貼付
```

---

## 14. 今後の拡張性

### 将来的に検討可能な改善

- **スクレイピングの自動化** - 現在は手作業だが、ログイン機構が整備できればセレニウムなどで自動化可能
- **定期実行化** - GitHub Actions や Google Cloud Scheduler で毎月自動実行
- **メール通知** - 処理完了時に通知メール送信
- **複数ユーザー対応** - Web UI を構築して複数人が使用可能に
- **データ履歴管理** - 月次データを別シートに自動アーカイブ
- **エラーログ** - 処理結果を Google Sheet に記録

### 設計上の配慮

現在のスクリプトは、これらの拡張を考慮した構造になっている：
- 関数分割で保守性を確保
- エラーメッセージが詳細
- 処理フローが明確

---

## 15. ドキュメント

### 関連資料

- **README.md** - 使い方クイックガイド
- **SPECIFICATION.md** - 本仕様書（詳細仕様）
- **script.py** - ソースコード

### 参考リンク

- [Google Colab 公式](https://colab.research.google.com/)
- [Google Sheets API ドキュメント](https://developers.google.com/sheets/api)
- [gspread ライブラリ](https://docs.gspread.org/)

---

## 16. 変更履歴

| バージョン | 日付 | 変更内容 |
|----------|------|--------|
| 1.0 | 2025-11-17 | 初版作成 |
| 1.1 | 2025-11-27 | バックアップ機能追加：データ更新前にスプレッドシート全体を自動コピー |
| 1.2 | 2025-11-27 | セキュリティ機能追加：スプレッドシート所有者チェック（共有ファイル保護） |
| 2.0 | 2025-11-30 | 大幅リファクタリング：スプレッドシート検索・選択機能、main関数化、認証処理分離 |
| 2.1 | 2025-11-30 | ファイル分離：認証処理をauth.pyに分離、Colabでの使いやすさ向上 |

---

**作成日:** 2025-11-17
**最終更新:** 2025-11-30
